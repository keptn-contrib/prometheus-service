name: 'Docker Build Push'
description: 'Docker build and Push'
inputs:
  TAGS:
    description: "List of tags to be pushed, e.g., keptncontrib/my-service:1.2.3"
    required: true
  VERSION:
    description: "Version/Tag that the image should be published with"
    required: true
  REGISTRY_USER:
    default: ''
  REGISTRY_PASSWORD:
    default: ''
  GITHUB_TOKEN:
    default: ''
runs:
  using: "composite"
  steps: 
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v1

    - name: Login to Docker Hub
      uses: docker/login-action@v1
      if: ${{ inputs.REGISTRY_USER != '' }}
      with:
        username: ${{ inputs.REGISTRY_USER }}
        password: ${{ inputs.REGISTRY_PASSWORD }}
        
    - name: Login to GitHub Container Registry
      if: ${{ inputs.GITHUB_TOKEN != '' }}
      uses: docker/login-action@v1
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ inputs.GITHUB_TOKEN }}

    - name: Load CI Environment from .ci_env
      id: load_ci_env
      uses: c-py/action-dotenv-to-setenv@v3
      with:
        env-file: .ci_env

    - id: docker_build_image
      name: "Docker Build"
      uses: docker/build-push-action@v2
      with:
        context: .
        tags: ${{ inputs.TAGS }}
        build-args: |
          version=${{ inputs.VERSION }}
        push: true
        pull: true # do we need this
